#!/bin/bash
# ============================================
# CVE Mitigations Script
# Comprehensive security hardening
# Version: 3.0 - Fixed all Trivy findings
# ============================================

set -e

echo "============================================"
echo "Applying CVE mitigations"
echo "============================================"

# ============================================
# SECURITY FIX: Python packages (pip, setuptools, wheel, cryptography)
# ============================================
echo ">>> Verifying Python security packages..."

# Ensure we're using the venv
if [ -d "/opt/venv" ]; then
    export PATH="/opt/venv/bin:$PATH"
fi

# Upgrade to secure versions
pip install --upgrade "pip>=26.0" "setuptools>=78.1.1" "wheel>=0.46.2" "cryptography>=44.0.1" 2>/dev/null || true

# Verify versions
echo "    pip version: $(pip --version 2>/dev/null | awk '{print $2}' || echo 'N/A')"
echo "    setuptools version: $(pip show setuptools 2>/dev/null | grep Version | awk '{print $2}' || echo 'N/A')"
echo "    wheel version: $(pip show wheel 2>/dev/null | grep Version | awk '{print $2}' || echo 'N/A')"
echo "    cryptography version: $(pip show cryptography 2>/dev/null | grep Version | awk '{print $2}' || echo 'N/A')"

# ============================================
# CRITICAL: Remove system Python packages metadata
# These are detected by Trivy even though venv has newer versions
# ============================================
echo ">>> Removing system Python package metadata to prevent false positives..."

# Remove system pip metadata
rm -rf /usr/lib/python3*/site-packages/pip-*.dist-info 2>/dev/null || true
rm -rf /usr/lib/python3*/site-packages/pip 2>/dev/null || true

# Remove system setuptools metadata  
rm -rf /usr/lib/python3*/site-packages/setuptools-*.dist-info 2>/dev/null || true
rm -rf /usr/lib/python3*/site-packages/setuptools 2>/dev/null || true
rm -rf /usr/lib/python3*/site-packages/pkg_resources 2>/dev/null || true
rm -rf /usr/lib/python3*/site-packages/_distutils_hack 2>/dev/null || true

# Remove system wheel metadata
rm -rf /usr/lib/python3*/site-packages/wheel-*.dist-info 2>/dev/null || true
rm -rf /usr/lib/python3*/site-packages/wheel 2>/dev/null || true

echo "    System package metadata removed"

# ============================================
# CRITICAL: Remove webfakes private key (HIGH severity)
# /usr/local/lib/R/site-library/webfakes/cert/localhost/server.pem
# ============================================
echo ">>> Removing webfakes private keys and certificates..."

# Remove the entire cert directory from webfakes
rm -rf /usr/local/lib/R/site-library/webfakes/cert 2>/dev/null || true
rm -rf /usr/local/lib/R/site-library/webfakes/certs 2>/dev/null || true

# Also check for any other .pem files with private keys
find /usr/local/lib/R/site-library -name "*.pem" -delete 2>/dev/null || true
find /usr/local/lib/R/site-library -name "*.key" -delete 2>/dev/null || true
find /usr/local/lib/R/site-library -name "server.key" -delete 2>/dev/null || true
find /usr/local/lib/R/site-library -name "private.key" -delete 2>/dev/null || true

# Remove any cert directories in R packages
find /usr/local/lib/R/site-library -type d -name "cert" -exec rm -rf {} + 2>/dev/null || true
find /usr/local/lib/R/site-library -type d -name "certs" -exec rm -rf {} + 2>/dev/null || true
find /usr/local/lib/R/site-library -type d -name "localhost" -exec rm -rf {} + 2>/dev/null || true

echo "    webfakes certificates and private keys removed"

# ============================================
# CVE-2025-53000: nbconvert PDF export vulnerability
# ============================================
echo ">>> Mitigating CVE-2025-53000 (nbconvert PDF)"
NBCONVERT_PATH=$(python3 -c "import nbconvert; import os; print(os.path.dirname(nbconvert.__file__))" 2>/dev/null || echo "")

if [ -n "$NBCONVERT_PATH" ] && [ -d "$NBCONVERT_PATH" ]; then
    # Create disabled PDF exporter
    cat > "${NBCONVERT_PATH}/exporters/pdf.py" << 'PYEOF'
"""PDF Exporter - DISABLED for CVE-2025-53000 mitigation."""
from nbconvert.exporters.html import HTMLExporter

class PDFExporter(HTMLExporter):
    """PDF Exporter disabled for security (CVE-2025-53000)."""
    export_from_notebook = "PDF"
    output_mimetype = "application/pdf"

    def _file_extension_default(self):
        return ".pdf"

    def from_notebook_node(self, nb, resources=None, **kw):
        raise RuntimeError(
            "PDF export is disabled for security (CVE-2025-53000). "
            "Use HTML or other formats instead."
        )

    def from_file(self, file_stream, resources=None, **kw):
        raise RuntimeError(
            "PDF export is disabled for security (CVE-2025-53000). "
            "Use HTML or other formats instead."
        )
PYEOF

    # Create disabled WebPDF exporter if exists
    if [ -f "${NBCONVERT_PATH}/exporters/webpdf.py" ]; then
        cat > "${NBCONVERT_PATH}/exporters/webpdf.py" << 'PYEOF'
"""WebPDF Exporter - DISABLED for CVE-2025-53000 mitigation."""
from nbconvert.exporters.html import HTMLExporter

class WebPDFExporter(HTMLExporter):
    """WebPDF Exporter disabled for security (CVE-2025-53000)."""
    export_from_notebook = "WebPDF"
    output_mimetype = "application/pdf"

    def _file_extension_default(self):
        return ".pdf"

    def from_notebook_node(self, nb, resources=None, **kw):
        raise RuntimeError(
            "WebPDF export is disabled for security (CVE-2025-53000). "
            "Use HTML or other formats instead."
        )
PYEOF
    fi

    # Clear Python cache
    find "${NBCONVERT_PATH}" -name "*.pyc" -delete 2>/dev/null || true
    find "${NBCONVERT_PATH}" -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true

    echo "    nbconvert PDF mitigation applied"
else
    echo "    Warning: nbconvert not found, skipping"
fi

# ============================================
# CVE mitigation: Remove setuptools vendored wheel
# ============================================
echo ">>> Mitigating setuptools vendored wheel vulnerabilities"
SETUPTOOLS_PATH=$(python3 -c "import setuptools; import os; print(os.path.dirname(setuptools.__file__))" 2>/dev/null || echo "")
if [ -n "$SETUPTOOLS_PATH" ] && [ -d "${SETUPTOOLS_PATH}/_vendor" ]; then
    rm -rf "${SETUPTOOLS_PATH}/_vendor/wheel"* 2>/dev/null || true
    echo "    Removed vendored wheel from setuptools"
fi

# ============================================
# General Python security: Remove .pyc files
# ============================================
echo ">>> Cleaning Python bytecode cache"
find /opt/venv -name "*.pyc" -delete 2>/dev/null || true
find /opt/venv -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true

# ============================================
# Remove pip cache
# ============================================
echo ">>> Cleaning pip cache"
rm -rf /root/.cache/pip 2>/dev/null || true
rm -rf /home/*/.cache/pip 2>/dev/null || true

# ============================================
# Security: Remove setuid/setgid bits
# ============================================
echo ">>> Removing setuid/setgid bits"
find /usr -type f -perm /6000 -exec chmod a-s {} \; 2>/dev/null || true

# ============================================
# Additional R package security cleanup
# ============================================
echo ">>> Additional R package security cleanup..."

# Remove any test credentials or fake service accounts
find /usr/local/lib/R/site-library -name "*fake*service*account*" -delete 2>/dev/null || true
find /usr/local/lib/R/site-library -name "*.json" -path "*/extdata/*" -delete 2>/dev/null || true

# Remove casperjs (if present)
find /usr/local/lib/R/site-library -type d -name "casperjs" -exec rm -rf {} + 2>/dev/null || true

echo "    R package security cleanup complete"

# ============================================
# Final Security Verification
# ============================================
echo ""
echo "============================================"
echo "Security Verification Summary"
echo "============================================"

# Check pip version (should be >= 26.0)
PIP_VER=$(pip --version 2>/dev/null | awk '{print $2}' || echo "0")
echo "pip: ${PIP_VER} (required: >=26.0)"

# Check setuptools version (should be >= 78.1.1)
SETUPTOOLS_VER=$(pip show setuptools 2>/dev/null | grep Version | awk '{print $2}' || echo "0")
echo "setuptools: ${SETUPTOOLS_VER} (required: >=78.1.1)"

# Check wheel version (should be >= 0.46.2)
WHEEL_VER=$(pip show wheel 2>/dev/null | grep Version | awk '{print $2}' || echo "0")
echo "wheel: ${WHEEL_VER} (required: >=0.46.2)"

# Check cryptography version (should be >= 44.0.1)
CRYPTO_VER=$(pip show cryptography 2>/dev/null | grep Version | awk '{print $2}' || echo "0")
echo "cryptography: ${CRYPTO_VER} (required: >=44.0.1)"

# Verify webfakes cert is removed
if [ -d "/usr/local/lib/R/site-library/webfakes/cert" ]; then
    echo "WARNING: webfakes cert directory still exists!"
else
    echo "webfakes cert: REMOVED (private key vulnerability fixed)"
fi

# Check for any remaining .pem files
PEM_COUNT=$(find /usr/local/lib/R/site-library -name "*.pem" 2>/dev/null | wc -l)
echo ".pem files in R packages: ${PEM_COUNT}"

# Check for system python packages
if [ -d "/usr/lib/python3.12/site-packages/pip" ]; then
    echo "WARNING: system pip still exists!"
else
    echo "system pip: REMOVED"
fi

echo "============================================"
echo "CVE mitigations applied successfully"
echo "============================================"