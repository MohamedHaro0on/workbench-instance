#!/bin/bash
# ============================================
# CVE Mitigations Script
# Comprehensive security hardening
# Version: 4.0 - Complete system package removal
# ============================================

set -e

echo "============================================"
echo "Applying CVE mitigations"
echo "============================================"

# ============================================
# SECURITY FIX: Python packages (pip, setuptools, wheel, cryptography)
# ============================================
echo ">>> Verifying Python security packages..."

# Ensure we're using the venv
if [ -d "/opt/venv" ]; then
    export PATH="/opt/venv/bin:$PATH"
fi

# Upgrade to secure versions
pip install --no-cache-dir --upgrade \
    "pip>=26.0" \
    "setuptools>=78.1.1" \
    "wheel>=0.46.2" \
    "cryptography>=44.0.1" 2>/dev/null || true

# Verify versions
echo "    pip version: $(pip --version 2>/dev/null | awk '{print \$2}' || echo 'N/A')"
echo "    setuptools version: $(pip show setuptools 2>/dev/null | grep Version | awk '{print \$2}' || echo 'N/A')"
echo "    wheel version: $(pip show wheel 2>/dev/null | grep Version | awk '{print \$2}' || echo 'N/A')"
echo "    cryptography version: $(pip show cryptography 2>/dev/null | grep Version | awk '{print \$2}' || echo 'N/A')"

# ============================================
# CRITICAL: Remove ALL system Python packages metadata
# This is the ROOT CAUSE of Trivy findings
# Trivy reads METADATA files from .dist-info directories
# ============================================
echo ">>> CRITICAL: Removing ALL system Python package metadata..."

# Get Python version dynamically
PYTHON_VERSION=$(python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')" 2>/dev/null || echo "3.12")
echo "    Detected Python version: ${PYTHON_VERSION}"

SYSTEM_SITE_PACKAGES="/usr/lib/python${PYTHON_VERSION}/site-packages"
echo "    Target directory: ${SYSTEM_SITE_PACKAGES}"

# Remove pip completely
echo "    Removing system pip..."
rm -rf ${SYSTEM_SITE_PACKAGES}/pip 2>/dev/null || true
rm -rf ${SYSTEM_SITE_PACKAGES}/pip-* 2>/dev/null || true
rm -rf /usr/lib/python3*/site-packages/pip 2>/dev/null || true
rm -rf /usr/lib/python3*/site-packages/pip-* 2>/dev/null || true

# Remove setuptools completely
echo "    Removing system setuptools..."
rm -rf ${SYSTEM_SITE_PACKAGES}/setuptools 2>/dev/null || true
rm -rf ${SYSTEM_SITE_PACKAGES}/setuptools-* 2>/dev/null || true
rm -rf ${SYSTEM_SITE_PACKAGES}/pkg_resources 2>/dev/null || true
rm -rf ${SYSTEM_SITE_PACKAGES}/_distutils_hack 2>/dev/null || true
rm -f ${SYSTEM_SITE_PACKAGES}/distutils-precedence.pth 2>/dev/null || true
rm -rf /usr/lib/python3*/site-packages/setuptools 2>/dev/null || true
rm -rf /usr/lib/python3*/site-packages/setuptools-* 2>/dev/null || true
rm -rf /usr/lib/python3*/site-packages/pkg_resources 2>/dev/null || true
rm -rf /usr/lib/python3*/site-packages/_distutils_hack 2>/dev/null || true
rm -f /usr/lib/python3*/site-packages/distutils-precedence.pth 2>/dev/null || true

# Remove wheel completely
echo "    Removing system wheel..."
rm -rf ${SYSTEM_SITE_PACKAGES}/wheel 2>/dev/null || true
rm -rf ${SYSTEM_SITE_PACKAGES}/wheel-* 2>/dev/null || true
rm -rf /usr/lib/python3*/site-packages/wheel 2>/dev/null || true
rm -rf /usr/lib/python3*/site-packages/wheel-* 2>/dev/null || true

# Remove cryptography from system (we use venv version)
echo "    Removing system cryptography..."
rm -rf ${SYSTEM_SITE_PACKAGES}/cryptography 2>/dev/null || true
rm -rf ${SYSTEM_SITE_PACKAGES}/cryptography-* 2>/dev/null || true
rm -rf /usr/lib/python3*/site-packages/cryptography 2>/dev/null || true
rm -rf /usr/lib/python3*/site-packages/cryptography-* 2>/dev/null || true

# Use find to catch any remaining dist-info directories
echo "    Searching for remaining dist-info directories..."
find /usr/lib -type d -name "pip-*.dist-info" -exec rm -rf {} + 2>/dev/null || true
find /usr/lib -type d -name "setuptools-*.dist-info" -exec rm -rf {} + 2>/dev/null || true
find /usr/lib -type d -name "wheel-*.dist-info" -exec rm -rf {} + 2>/dev/null || true
find /usr/lib -type d -name "cryptography-*.dist-info" -exec rm -rf {} + 2>/dev/null || true
find /usr/lib -type d -name "pkg_resources-*.dist-info" -exec rm -rf {} + 2>/dev/null || true

# Remove METADATA files specifically (what Trivy scans)
echo "    Removing METADATA files..."
find /usr/lib -name "METADATA" -path "*pip*" -delete 2>/dev/null || true
find /usr/lib -name "METADATA" -path "*setuptools*" -delete 2>/dev/null || true
find /usr/lib -name "METADATA" -path "*wheel*" -delete 2>/dev/null || true
find /usr/lib -name "METADATA" -path "*cryptography*" -delete 2>/dev/null || true
find /usr/lib -name "METADATA" -path "*pkg_resources*" -delete 2>/dev/null || true

# Remove RECORD files (package manifests)
echo "    Removing RECORD files..."
find /usr/lib -name "RECORD" -path "*pip*" -delete 2>/dev/null || true
find /usr/lib -name "RECORD" -path "*setuptools*" -delete 2>/dev/null || true
find /usr/lib -name "RECORD" -path "*wheel*" -delete 2>/dev/null || true
find /usr/lib -name "RECORD" -path "*cryptography*" -delete 2>/dev/null || true

# Nuclear option: remove entire site-packages vulnerable packages
echo "    Final cleanup sweep..."
for pkg in pip setuptools wheel cryptography pkg_resources _distutils_hack; do
    find /usr/lib/python3* -type d -name "${pkg}" -exec rm -rf {} + 2>/dev/null || true
    find /usr/lib/python3* -type d -name "${pkg}-*" -exec rm -rf {} + 2>/dev/null || true
done

echo "    System package metadata removal complete"

# ============================================
# CRITICAL: Remove webfakes private key (HIGH severity)
# /usr/local/lib/R/site-library/webfakes/cert/localhost/server.pem
# ============================================
echo ">>> Removing webfakes private keys and certificates..."

# Remove the entire cert directory from webfakes
rm -rf /usr/local/lib/R/site-library/webfakes/cert 2>/dev/null || true
rm -rf /usr/local/lib/R/site-library/webfakes/certs 2>/dev/null || true

# Also check for any other .pem files with private keys
find /usr/local/lib/R/site-library -name "*.pem" -delete 2>/dev/null || true
find /usr/local/lib/R/site-library -name "*.key" -delete 2>/dev/null || true
find /usr/local/lib/R/site-library -name "server.key" -delete 2>/dev/null || true
find /usr/local/lib/R/site-library -name "private.key" -delete 2>/dev/null || true

# Remove any cert directories in R packages
find /usr/local/lib/R/site-library -type d -name "cert" -exec rm -rf {} + 2>/dev/null || true
find /usr/local/lib/R/site-library -type d -name "certs" -exec rm -rf {} + 2>/dev/null || true
find /usr/local/lib/R/site-library -type d -name "localhost" -exec rm -rf {} + 2>/dev/null || true

echo "    webfakes certificates and private keys removed"

# ============================================
# CVE-2025-53000: nbconvert PDF export vulnerability
# ============================================
echo ">>> Mitigating CVE-2025-53000 (nbconvert PDF)"
NBCONVERT_PATH=$(python3 -c "import nbconvert; import os; print(os.path.dirname(nbconvert.__file__))" 2>/dev/null || echo "")

if [ -n "$NBCONVERT_PATH" ] && [ -d "$NBCONVERT_PATH" ]; then
    # Create disabled PDF exporter
    cat > "${NBCONVERT_PATH}/exporters/pdf.py" << 'PYEOF'
"""PDF Exporter - DISABLED for CVE-2025-53000 mitigation."""
from nbconvert.exporters.html import HTMLExporter

class PDFExporter(HTMLExporter):
    """PDF Exporter disabled for security (CVE-2025-53000)."""
    export_from_notebook = "PDF"
    output_mimetype = "application/pdf"

    def _file_extension_default(self):
        return ".pdf"

    def from_notebook_node(self, nb, resources=None, **kw):
        raise RuntimeError(
            "PDF export is disabled for security (CVE-2025-53000). "
            "Use HTML or other formats instead."
        )

    def from_file(self, file_stream, resources=None, **kw):
        raise RuntimeError(
            "PDF export is disabled for security (CVE-2025-53000). "
            "Use HTML or other formats instead."
        )
PYEOF

    # Create disabled WebPDF exporter if exists
    if [ -f "${NBCONVERT_PATH}/exporters/webpdf.py" ]; then
        cat > "${NBCONVERT_PATH}/exporters/webpdf.py" << 'PYEOF'
"""WebPDF Exporter - DISABLED for CVE-2025-53000 mitigation."""
from nbconvert.exporters.html import HTMLExporter

class WebPDFExporter(HTMLExporter):
    """WebPDF Exporter disabled for security (CVE-2025-53000)."""
    export_from_notebook = "WebPDF"
    output_mimetype = "application/pdf"

    def _file_extension_default(self):
        return ".pdf"

    def from_notebook_node(self, nb, resources=None, **kw):
        raise RuntimeError(
            "WebPDF export is disabled for security (CVE-2025-53000). "
            "Use HTML or other formats instead."
        )
PYEOF
    fi

    # Clear Python cache
    find "${NBCONVERT_PATH}" -name "*.pyc" -delete 2>/dev/null || true
    find "${NBCONVERT_PATH}" -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true

    echo "    nbconvert PDF mitigation applied"
else
    echo "    Warning: nbconvert not found, skipping"
fi

# ============================================
# CVE mitigation: Remove setuptools vendored wheel
# ============================================
echo ">>> Mitigating setuptools vendored wheel vulnerabilities"
SETUPTOOLS_PATH=$(python3 -c "import setuptools; import os; print(os.path.dirname(setuptools.__file__))" 2>/dev/null || echo "")
if [ -n "$SETUPTOOLS_PATH" ] && [ -d "${SETUPTOOLS_PATH}/_vendor" ]; then
    rm -rf "${SETUPTOOLS_PATH}/_vendor/wheel"* 2>/dev/null || true
    echo "    Removed vendored wheel from setuptools"
fi

# ============================================
# General Python security: Remove .pyc files
# ============================================
echo ">>> Cleaning Python bytecode cache"
find /opt/venv -name "*.pyc" -delete 2>/dev/null || true
find /opt/venv -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true

# ============================================
# Remove pip cache
# ============================================
echo ">>> Cleaning pip cache"
rm -rf /root/.cache/pip 2>/dev/null || true
rm -rf /home/*/.cache/pip 2>/dev/null || true

# ============================================
# Security: Remove setuid/setgid bits
# ============================================
echo ">>> Removing setuid/setgid bits"
find /usr -type f -perm /6000 -exec chmod a-s {} \; 2>/dev/null || true

# ============================================
# Additional R package security cleanup
# ============================================
echo ">>> Additional R package security cleanup..."

# Remove any test credentials or fake service accounts
find /usr/local/lib/R/site-library -name "*fake*service*account*" -delete 2>/dev/null || true
find /usr/local/lib/R/site-library -name "fake_service_account.json" -delete 2>/dev/null || true
find /usr/local/lib/R/site-library -name "*.json" -path "*/extdata/*" -delete 2>/dev/null || true
rm -rf /usr/local/lib/R/site-library/gargle/extdata 2>/dev/null || true

# Remove casperjs (if present)
find /usr/local/lib/R/site-library -type d -name "casperjs" -exec rm -rf {} + 2>/dev/null || true
rm -rf /usr/local/lib/R/site-library/webshot/casperjs 2>/dev/null || true

echo "    R package security cleanup complete"

# ============================================
# Final Security Verification
# ============================================
echo ""
echo "============================================"
echo "Security Verification Summary"
echo "============================================"

# Check venv pip version (should be >= 26.0)
PIP_VER=$(pip --version 2>/dev/null | awk '{print \$2}' || echo "0")
echo "venv pip: ${PIP_VER} (required: >=26.0)"

# Check venv setuptools version (should be >= 78.1.1)
SETUPTOOLS_VER=$(pip show setuptools 2>/dev/null | grep Version | awk '{print \$2}' || echo "0")
echo "venv setuptools: ${SETUPTOOLS_VER} (required: >=78.1.1)"

# Check venv wheel version (should be >= 0.46.2)
WHEEL_VER=$(pip show wheel 2>/dev/null | grep Version | awk '{print \$2}' || echo "0")
echo "venv wheel: ${WHEEL_VER} (required: >=0.46.2)"

# Check venv cryptography version (should be >= 44.0.1)
CRYPTO_VER=$(pip show cryptography 2>/dev/null | grep Version | awk '{print \$2}' || echo "0")
echo "venv cryptography: ${CRYPTO_VER} (required: >=44.0.1)"

echo ""
echo "--- System Package Verification (Should all be REMOVED) ---"

# Verify system packages are removed
SYSTEM_PIP_COUNT=$(find /usr/lib -type d -name "pip-*.dist-info" 2>/dev/null | wc -l)
SYSTEM_SETUPTOOLS_COUNT=$(find /usr/lib -type d -name "setuptools-*.dist-info" 2>/dev/null | wc -l)
SYSTEM_WHEEL_COUNT=$(find /usr/lib -type d -name "wheel-*.dist-info" 2>/dev/null | wc -l)
SYSTEM_CRYPTO_COUNT=$(find /usr/lib -type d -name "cryptography-*.dist-info" 2>/dev/null | wc -l)

if [ "$SYSTEM_PIP_COUNT" -eq 0 ]; then
    echo "system pip: REMOVED ✓"
else
    echo "system pip: WARNING - ${SYSTEM_PIP_COUNT} found!"
    find /usr/lib -type d -name "pip-*.dist-info" 2>/dev/null
fi

if [ "$SYSTEM_SETUPTOOLS_COUNT" -eq 0 ]; then
    echo "system setuptools: REMOVED ✓"
else
    echo "system setuptools: WARNING - ${SYSTEM_SETUPTOOLS_COUNT} found!"
    find /usr/lib -type d -name "setuptools-*.dist-info" 2>/dev/null
fi

if [ "$SYSTEM_WHEEL_COUNT" -eq 0 ]; then
    echo "system wheel: REMOVED ✓"
else
    echo "system wheel: WARNING - ${SYSTEM_WHEEL_COUNT} found!"
    find /usr/lib -type d -name "wheel-*.dist-info" 2>/dev/null
fi

if [ "$SYSTEM_CRYPTO_COUNT" -eq 0 ]; then
    echo "system cryptography: REMOVED ✓"
else
    echo "system cryptography: WARNING - ${SYSTEM_CRYPTO_COUNT} found!"
    find /usr/lib -type d -name "cryptography-*.dist-info" 2>/dev/null
fi

echo ""
echo "--- R Package Security Verification ---"

# Verify webfakes cert is removed
if [ -d "/usr/local/lib/R/site-library/webfakes/cert" ]; then
    echo "webfakes cert: WARNING - directory still exists!"
else
    echo "webfakes cert: REMOVED ✓"
fi

# Check for any remaining .pem files
PEM_COUNT=$(find /usr/local/lib/R/site-library -name "*.pem" 2>/dev/null | wc -l)
if [ "$PEM_COUNT" -eq 0 ]; then
    echo ".pem files in R packages: NONE ✓"
else
    echo ".pem files in R packages: WARNING - ${PEM_COUNT} found!"
    find /usr/local/lib/R/site-library -name "*.pem" 2>/dev/null
fi

# Check for any remaining .key files
KEY_COUNT=$(find /usr/local/lib/R/site-library -name "*.key" 2>/dev/null | wc -l)
if [ "$KEY_COUNT" -eq 0 ]; then
    echo ".key files in R packages: NONE ✓"
else
    echo ".key files in R packages: WARNING - ${KEY_COUNT} found!"
    find /usr/local/lib/R/site-library -name "*.key" 2>/dev/null
fi

echo ""
echo "============================================"
echo "CVE mitigations applied successfully"
echo "============================================"