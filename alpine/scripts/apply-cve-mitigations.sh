#!/bin/bash
# ============================================
# CVE Mitigations Script
# Version: 4.0 - Complete system package removal
# ============================================

set -e

echo "============================================"
echo "Applying CVE mitigations"
echo "============================================"

# Ensure we're using the venv
if [ -d "/opt/venv" ]; then
    export PATH="/opt/venv/bin:$PATH"
fi

# ============================================
# SECURITY: Upgrade venv packages
# ============================================
echo ">>> Upgrading venv packages to secure versions..."
pip install --upgrade "pip>=26.0" "setuptools>=78.1.1" "wheel>=0.46.2" "cryptography>=44.0.1" 2>/dev/null || true

echo "    pip: $(pip --version 2>/dev/null | awk '{print $2}')"
echo "    setuptools: $(pip show setuptools 2>/dev/null | grep Version | awk '{print $2}')"
echo "    wheel: $(pip show wheel 2>/dev/null | grep Version | awk '{print $2}')"
echo "    cryptography: $(pip show cryptography 2>/dev/null | grep Version | awk '{print $2}')"

# ============================================
# CRITICAL: Remove ALL system Python packages
# ============================================
echo ">>> CRITICAL: Removing ALL system Python packages..."

# Remove from /usr/lib
for pyver in /usr/lib/python3*; do
    if [ -d "$pyver/site-packages" ]; then
        echo "    Cleaning $pyver/site-packages..."
        rm -rf "$pyver/site-packages/pip" 2>/dev/null || true
        rm -rf "$pyver/site-packages/pip-"* 2>/dev/null || true
        rm -rf "$pyver/site-packages/setuptools" 2>/dev/null || true
        rm -rf "$pyver/site-packages/setuptools-"* 2>/dev/null || true
        rm -rf "$pyver/site-packages/pkg_resources" 2>/dev/null || true
        rm -rf "$pyver/site-packages/_distutils_hack" 2>/dev/null || true
        rm -rf "$pyver/site-packages/wheel" 2>/dev/null || true
        rm -rf "$pyver/site-packages/wheel-"* 2>/dev/null || true
        rm -rf "$pyver/site-packages/cryptography" 2>/dev/null || true
        rm -rf "$pyver/site-packages/cryptography-"* 2>/dev/null || true
    fi
done

# Remove from /usr/local/lib
for pyver in /usr/local/lib/python3*; do
    if [ -d "$pyver/site-packages" ]; then
        echo "    Cleaning $pyver/site-packages..."
        rm -rf "$pyver/site-packages/pip" 2>/dev/null || true
        rm -rf "$pyver/site-packages/pip-"* 2>/dev/null || true
        rm -rf "$pyver/site-packages/setuptools" 2>/dev/null || true
        rm -rf "$pyver/site-packages/setuptools-"* 2>/dev/null || true
        rm -rf "$pyver/site-packages/pkg_resources" 2>/dev/null || true
        rm -rf "$pyver/site-packages/_distutils_hack" 2>/dev/null || true
        rm -rf "$pyver/site-packages/wheel" 2>/dev/null || true
        rm -rf "$pyver/site-packages/wheel-"* 2>/dev/null || true
        rm -rf "$pyver/site-packages/cryptography" 2>/dev/null || true
        rm -rf "$pyver/site-packages/cryptography-"* 2>/dev/null || true
    fi
done

# Use find to catch any remaining dist-info directories
find /usr/lib -type d -name "pip-*.dist-info" -exec rm -rf {} + 2>/dev/null || true
find /usr/lib -type d -name "setuptools-*.dist-info" -exec rm -rf {} + 2>/dev/null || true
find /usr/lib -type d -name "wheel-*.dist-info" -exec rm -rf {} + 2>/dev/null || true
find /usr/lib -type d -name "cryptography-*.dist-info" -exec rm -rf {} + 2>/dev/null || true
find /usr/local/lib -type d -name "pip-*.dist-info" -exec rm -rf {} + 2>/dev/null || true
find /usr/local/lib -type d -name "setuptools-*.dist-info" -exec rm -rf {} + 2>/dev/null || true
find /usr/local/lib -type d -name "wheel-*.dist-info" -exec rm -rf {} + 2>/dev/null || true
find /usr/local/lib -type d -name "cryptography-*.dist-info" -exec rm -rf {} + 2>/dev/null || true

echo "    System Python packages removed"

# ============================================
# Remove webfakes private keys
# ============================================
echo ">>> Removing webfakes private keys..."
rm -rf /usr/local/lib/R/site-library/webfakes/cert 2>/dev/null || true
find /usr/local/lib/R/site-library -name "*.pem" -delete 2>/dev/null || true
find /usr/local/lib/R/site-library -name "*.key" -delete 2>/dev/null || true
find /usr/local/lib/R/site-library -type d -name "cert" -exec rm -rf {} + 2>/dev/null || true
find /usr/local/lib/R/site-library -type d -name "certs" -exec rm -rf {} + 2>/dev/null || true
find /usr/local/lib/R/site-library -type d -name "localhost" -exec rm -rf {} + 2>/dev/null || true

# ============================================
# nbconvert PDF mitigation
# ============================================
echo ">>> Mitigating nbconvert PDF vulnerability..."
NBCONVERT_PATH=$(python3 -c "import nbconvert; import os; print(os.path.dirname(nbconvert.__file__))" 2>/dev/null || echo "")
if [ -n "$NBCONVERT_PATH" ] && [ -d "$NBCONVERT_PATH" ]; then
    cat > "${NBCONVERT_PATH}/exporters/pdf.py" << 'PYEOF'
"""PDF Exporter - DISABLED for security."""
from nbconvert.exporters.html import HTMLExporter
class PDFExporter(HTMLExporter):
    export_from_notebook = "PDF"
    output_mimetype = "application/pdf"
    def _file_extension_default(self):
        return ".pdf"
    def from_notebook_node(self, nb, resources=None, **kw):
        raise RuntimeError("PDF export disabled for security. Use HTML instead.")
    def from_file(self, file_stream, resources=None, **kw):
        raise RuntimeError("PDF export disabled for security. Use HTML instead.")
PYEOF
    find "${NBCONVERT_PATH}" -name "*.pyc" -delete 2>/dev/null || true
    find "${NBCONVERT_PATH}" -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
fi

# ============================================
# Remove setuptools vendored wheel
# ============================================
echo ">>> Removing setuptools vendored wheel..."
SETUPTOOLS_PATH=$(python3 -c "import setuptools; import os; print(os.path.dirname(setuptools.__file__))" 2>/dev/null || echo "")
if [ -n "$SETUPTOOLS_PATH" ] && [ -d "${SETUPTOOLS_PATH}/_vendor" ]; then
    rm -rf "${SETUPTOOLS_PATH}/_vendor/wheel"* 2>/dev/null || true
fi

# ============================================
# Cleanup
# ============================================
echo ">>> Final cleanup..."
find /opt/venv -name "*.pyc" -delete 2>/dev/null || true
find /opt/venv -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
rm -rf /root/.cache/pip 2>/dev/null || true
find /usr -type f -perm /6000 -exec chmod a-s {} \; 2>/dev/null || true

# ============================================
# Verification
# ============================================
echo ""
echo "============================================"
echo "Security Verification"
echo "============================================"
echo "Venv pip: $(pip --version 2>/dev/null | awk '{print $2}')"
echo "Venv setuptools: $(pip show setuptools 2>/dev/null | grep Version | awk '{print $2}')"
echo "Venv wheel: $(pip show wheel 2>/dev/null | grep Version | awk '{print $2}')"
echo "Venv cryptography: $(pip show cryptography 2>/dev/null | grep Version | awk '{print $2}')"
echo ""
echo "System packages check:"
(ls /usr/lib/python3*/site-packages/pip* 2>/dev/null && echo "WARNING: System pip exists!") || echo "  OK: No system pip"
(ls /usr/lib/python3*/site-packages/setuptools* 2>/dev/null && echo "WARNING: System setuptools exists!") || echo "  OK: No system setuptools"
(ls /usr/lib/python3*/site-packages/wheel* 2>/dev/null && echo "WARNING: System wheel exists!") || echo "  OK: No system wheel"
echo "============================================"