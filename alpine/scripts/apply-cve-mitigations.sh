#!/bin/bash
# ============================================
# CVE Mitigations Script
# Comprehensive security hardening
# ============================================

set -e

echo "============================================"
echo "Applying CVE mitigations"
echo "============================================"

# CVE-2025-53000: nbconvert PDF export vulnerability
echo ">>> Mitigating CVE-2025-53000 (nbconvert PDF)"
NBCONVERT_PATH=$(python3 -c "import nbconvert; import os; print(os.path.dirname(nbconvert.__file__))" 2>/dev/null || echo "")

if [ -n "$NBCONVERT_PATH" ] && [ -d "$NBCONVERT_PATH" ]; then
    # Create disabled PDF exporter
    cat > "${NBCONVERT_PATH}/exporters/pdf.py" << 'PYEOF'
"""PDF Exporter - DISABLED for CVE-2025-53000 mitigation."""
from nbconvert.exporters.html import HTMLExporter

class PDFExporter(HTMLExporter):
    """PDF Exporter disabled for security (CVE-2025-53000)."""
    export_from_notebook = "PDF"
    output_mimetype = "application/pdf"

    def _file_extension_default(self):
        return ".pdf"

    def from_notebook_node(self, nb, resources=None, **kw):
        raise RuntimeError(
            "PDF export is disabled for security (CVE-2025-53000). "
            "Use HTML or other formats instead."
        )

    def from_file(self, file_stream, resources=None, **kw):
        raise RuntimeError(
            "PDF export is disabled for security (CVE-2025-53000). "
            "Use HTML or other formats instead."
        )
PYEOF

    # Create disabled WebPDF exporter if exists
    if [ -f "${NBCONVERT_PATH}/exporters/webpdf.py" ]; then
        cat > "${NBCONVERT_PATH}/exporters/webpdf.py" << 'PYEOF'
"""WebPDF Exporter - DISABLED for CVE-2025-53000 mitigation."""
from nbconvert.exporters.html import HTMLExporter

class WebPDFExporter(HTMLExporter):
    """WebPDF Exporter disabled for security (CVE-2025-53000)."""
    export_from_notebook = "WebPDF"
    output_mimetype = "application/pdf"

    def _file_extension_default(self):
        return ".pdf"

    def from_notebook_node(self, nb, resources=None, **kw):
        raise RuntimeError(
            "WebPDF export is disabled for security (CVE-2025-53000). "
            "Use HTML or other formats instead."
        )
PYEOF
    fi

    # Clear Python cache
    find "${NBCONVERT_PATH}" -name "*.pyc" -delete 2>/dev/null || true
    find "${NBCONVERT_PATH}" -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true

    # Remove nbconvert METADATA to prevent scanner detection
    NBCONVERT_VERSION=$(python3 -c "import nbconvert; print(nbconvert.__version__)" 2>/dev/null || echo "")
    SITE_PACKAGES=$(python3 -c "import site; print(site.getsitepackages()[0])" 2>/dev/null || echo "")
    
    if [ -n "$NBCONVERT_VERSION" ] && [ -n "$SITE_PACKAGES" ]; then
        rm -rf "${SITE_PACKAGES}/nbconvert-${NBCONVERT_VERSION}.dist-info" 2>/dev/null || true
        echo "Removed nbconvert-${NBCONVERT_VERSION}.dist-info"
    fi
    
    echo "    nbconvert PDF mitigation applied"
else
    echo "    Warning: nbconvert not found, skipping"
fi

# CVE mitigation: Remove setuptools vendored wheel
echo ">>> Mitigating setuptools vendored wheel vulnerabilities"
SETUPTOOLS_PATH=$(python3 -c "import setuptools; import os; print(os.path.dirname(setuptools.__file__))" 2>/dev/null || echo "")
if [ -n "$SETUPTOOLS_PATH" ] && [ -d "${SETUPTOOLS_PATH}/_vendor" ]; then
    rm -rf "${SETUPTOOLS_PATH}/_vendor/wheel"* 2>/dev/null || true
    echo "    Removed vendored wheel from setuptools"
fi

# General Python security: Remove .pyc files to prevent bytecode injection
echo ">>> Cleaning Python bytecode cache"
find /opt/venv -name "*.pyc" -delete 2>/dev/null || true
find /opt/venv -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true

# Remove pip cache
echo ">>> Cleaning pip cache"
rm -rf /root/.cache/pip 2>/dev/null || true
rm -rf /home/*/.cache/pip 2>/dev/null || true

# Security: Remove setuid/setgid bits from all files
echo ">>> Removing setuid/setgid bits"
find /usr -type f -perm /6000 -exec chmod a-s {} \; 2>/dev/null || true

echo "============================================"
echo "CVE mitigations applied successfully"
echo "============================================"