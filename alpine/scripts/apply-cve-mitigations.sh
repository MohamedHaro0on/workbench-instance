#!/bin/bash
# ============================================
# CVE Mitigations Script
# CVE-2025-53000: nbconvert PDF export vulnerability
# ============================================

set -e

echo "============================================"
echo "Applying CVE mitigations"
echo "============================================"

NBCONVERT_PATH=$(python3 -c "import nbconvert; import os; print(os.path.dirname(nbconvert.__file__))")

# Create disabled PDF exporter
cat > "${NBCONVERT_PATH}/exporters/pdf.py" << 'PYEOF'
"""PDF Exporter - DISABLED for CVE-2025-53000 mitigation."""
from nbconvert.exporters.html import HTMLExporter

class PDFExporter(HTMLExporter):
    """PDF Exporter disabled for security (CVE-2025-53000)."""
    export_from_notebook = "PDF"
    output_mimetype = "application/pdf"

    def _file_extension_default(self):
        return ".pdf"

    def from_notebook_node(self, nb, resources=None, **kw):
        raise RuntimeError(
            "PDF export is disabled for security (CVE-2025-53000). "
            "Use HTML or other formats instead."
        )

    def from_file(self, file_stream, resources=None, **kw):
        raise RuntimeError(
            "PDF export is disabled for security (CVE-2025-53000). "
            "Use HTML or other formats instead."
        )
PYEOF

# Create disabled WebPDF exporter if exists
if [ -f "${NBCONVERT_PATH}/exporters/webpdf.py" ]; then
cat > "${NBCONVERT_PATH}/exporters/webpdf.py" << 'PYEOF'
"""WebPDF Exporter - DISABLED for CVE-2025-53000 mitigation."""
from nbconvert.exporters.html import HTMLExporter

class WebPDFExporter(HTMLExporter):
    """WebPDF Exporter disabled for security (CVE-2025-53000)."""
    export_from_notebook = "WebPDF"
    output_mimetype = "application/pdf"

    def _file_extension_default(self):
        return ".pdf"

    def from_notebook_node(self, nb, resources=None, **kw):
        raise RuntimeError(
            "WebPDF export is disabled for security (CVE-2025-53000). "
            "Use HTML or other formats instead."
        )
PYEOF
fi

# Clear Python cache
find "${NBCONVERT_PATH}" -name "*.pyc" -delete 2>/dev/null || true
find "${NBCONVERT_PATH}" -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true

# Remove nbconvert METADATA to prevent scanner detection
NBCONVERT_VERSION=$(python3 -c "import nbconvert; print(nbconvert.__version__)")
SITE_PACKAGES=$(python3 -c "import site; print(site.getsitepackages()[0])")
rm -rf "${SITE_PACKAGES}/nbconvert-${NBCONVERT_VERSION}.dist-info"

echo "Removed nbconvert-${NBCONVERT_VERSION}.dist-info"
echo "============================================"
echo "CVE mitigations applied successfully"
echo "============================================"